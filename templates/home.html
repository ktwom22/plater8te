{% extends "base.html" %}

{% block title %}Plate Feed{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4 text-center">Plate Feed</h1>
    <div class="row justify-content-center" id="plate-feed" data-user="{{ session.get('user_id') }}">
        {% for plate in plates %}
        <div class="col-12 col-md-6 col-lg-4 mb-4">
            <div class="card shadow-sm border-0 rounded">
                <img src="{{ plate.image_url }}" class="card-img-top rounded-top" alt="{{ plate.name }}">
                <div class="card-body d-flex flex-column">
                    <!-- User + Date -->
                    <div class="d-flex justify-content-between mb-2 flex-wrap">
                        <span class="fw-bold">{{ plate.user.username }}</span>
                        <span class="text-muted small">{{ plate.created_at.strftime('%b %d, %Y') }}</span>
                    </div>
                    <!-- Name + Rating -->
                    <h5 class="card-title mb-1">{{ plate.name }} ({{ plate.rating }}/5)</h5>
                    <!-- Description -->
                    <p class="card-text mb-2">{{ plate.description }}</p>
                    <!-- Restaurant -->
                    <p class="mb-2 text-muted small">
                        Restaurant:
                        {% if plate.restaurant.website %}
                            <a href="{{ plate.restaurant.website }}" target="_blank">{{ plate.restaurant.name }}</a>
                        {% else %}
                            {{ plate.restaurant.name }}
                        {% endif %}<br>
                        Address: {{ plate.restaurant.address }}
                    </p>
                    <!-- Buttons -->
                    <div class="d-flex justify-content-between mt-auto flex-wrap gap-2">
                        <button class="btn btn-outline-primary btn-sm like-btn flex-grow-1" data-plate="{{ plate.id }}">
                            ‚ù§Ô∏è Like (<span class="like-count">{{ plate.like_count }}</span>)
                        </button>
                        <button class="btn btn-outline-secondary btn-sm comment-toggle flex-grow-1" data-plate="{{ plate.id }}">
                            üí¨ Comment
                        </button>
                    </div>
                    <!-- Comments -->
                    <div class="comment-section mt-2" id="comments-{{ plate.id }}" style="display:none;">
                        <ul class="list-group mb-2">
                            {% for comment in plate.comments %}
                            <li class="list-group-item py-1 px-2">
                                <strong>{{ comment.user.username }}:</strong> {{ comment.text }}
                            </li>
                            {% endfor %}
                        </ul>
                        <form class="comment-form" data-plate="{{ plate.id }}">
                            <div class="input-group input-group-sm">
                                <input type="text" name="text" class="form-control" placeholder="Write a comment..." required>
                                <button class="btn btn-primary" type="submit">Post</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const plateFeed = document.getElementById('plate-feed');
    const userId = plateFeed.dataset.user;

    // Like Button
    plateFeed.addEventListener('click', function(e) {
        if(e.target.classList.contains('like-btn')) {
            const btn = e.target;
            const plateId = btn.dataset.plate;
            fetch(`/plate/${plateId}/like`, {
                method: 'POST',
                headers: {'Content-Type':'application/x-www-form-urlencoded'},
                body: `user_id=${userId}`
            })
            .then(res => res.json())
            .then(data => {
                if(data.like_count !== undefined){
                    btn.querySelector('.like-count').textContent = data.like_count;
                }
            });
        }
    });

    // Comment Toggle
    plateFeed.addEventListener('click', function(e){
        if(e.target.classList.contains('comment-toggle')) {
            const plateId = e.target.dataset.plate;
            const section = document.getElementById(`comments-${plateId}`);
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }
    });

    // Comment Submission
    plateFeed.addEventListener('submit', function(e){
        if(e.target.classList.contains('comment-form')){
            e.preventDefault();
            const form = e.target;
            const plateId = form.dataset.plate;
            const text = form.querySelector('input[name="text"]').value;
            fetch(`/plate/${plateId}/comment`, {
                method: 'POST',
                headers: {'Content-Type':'application/x-www-form-urlencoded'},
                body: `user_id=${userId}&text=${encodeURIComponent(text)}`
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    const ul = form.querySelector('ul') || form.previousElementSibling;
                    const li = document.createElement('li');
                    li.className = 'list-group-item py-1 px-2';
                    li.innerHTML = `<strong>${data.username}:</strong> ${text}`;
                    ul.appendChild(li);
                    form.reset();
                }
            });
        }
    });
});
</script>
{% endblock %}
