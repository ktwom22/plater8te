{% extends "base.html" %}

{% block title %}Plate Feed{% endblock %}

{% block content %}

<style>
/* --- MOBILE FRIENDLY + MODERN FEED CARDS --- */
.card {
    border-radius: 16px !important;
    overflow: hidden;
}

.card-img-top {
    width: 100%;
    height: 260px;
    object-fit: cover;
}

@media (max-width: 768px) {
    .card-img-top {
        height: 200px;
    }
}

.card-body {
    display: flex;
    flex-direction: column;
}

.card {
    display: flex;
    flex-direction: column;
}

.list-group-item {
    font-size: 0.9rem;
}

/* Make buttons full-width on mobile */
@media (max-width: 576px) {
    .like-btn, .comment-toggle {
        width: 48%;
    }
}
</style>

<div class="container">
    <h1 class="mb-4 text-center">Plate Feed</h1>

    <div class="row justify-content-center" id="plate-feed" data-user="{{ session.get('user_id') }}">
        {% for plate in plates %}
            <div class="col-12 col-md-6 col-lg-4 mb-4">
                <div class="card shadow-sm">

                    <!-- IMAGE -->
                    <img src="{{ plate.image_url }}" class="card-img-top" alt="{{ plate.name }}">

                    <div class="card-body">

                        <!-- USER + DATE -->
                        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
                            <span class="fw-bold">
                                {{ plate.user.username if plate.user else "Unknown User" }}
                            </span>

                            {% if plate.created_at %}
                                <span class="text-muted small">
                                    {{ plate.created_at.strftime('%b %d, %Y') }}
                                </span>
                            {% else %}
                                <span class="text-muted small">No date</span>
                            {% endif %}
                        </div>

                        <!-- NAME + RATING -->
                        <h5 class="card-title mb-1">
                            {{ plate.name }}
                            <span class="text-warning">({{ plate.rating }}/5)</span>
                        </h5>

                        <!-- DESCRIPTION -->
                        <p class="card-text mb-2">{{ plate.description }}</p>

                        <!-- RESTAURANT DETAILS -->
                        <p class="mb-2 text-muted small">
                            {% if plate.restaurant %}
                                <strong>Restaurant:</strong> {{ plate.restaurant.name }}<br>

                                {% if plate.restaurant.website %}
                                    {% set website_url = plate.restaurant.website %}
                                    {% if not website_url.startswith('http') %}
                                        {% set website_url = 'https://' ~ website_url %}
                                    {% endif %}
                                    <strong>Website:</strong>
                                    <a href="{{ website_url }}" target="_blank" rel="noopener">{{ website_url }}</a><br>
                                {% endif %}

                                <strong>Address:</strong>
                                {% if plate.restaurant.latitude and plate.restaurant.longitude %}
                                    <a href="https://www.google.com/maps/dir/?api=1&destination={{ plate.restaurant.latitude }},{{ plate.restaurant.longitude }}" target="_blank" rel="noopener">
                                        {{ plate.restaurant.address }}
                                    </a>
                                {% else %}
                                    {{ plate.restaurant.address }}
                                {% endif %}
                            {% else %}
                                <em>No restaurant info</em>
                            {% endif %}
                        </p>

                        <!-- BUTTONS -->
                        <div class="d-flex justify-content-between mt-auto flex-wrap gap-2">
                            <button class="btn btn-outline-primary btn-sm like-btn flex-grow-1" data-plate="{{ plate.id }}">
                                ‚ù§Ô∏è Like (<span class="like-count">{{ plate.like_count or 0 }}</span>)
                            </button>

                            <button class="btn btn-outline-secondary btn-sm comment-toggle flex-grow-1" data-plate="{{ plate.id }}">
                                üí¨ Comment
                            </button>
                        </div>

                        <!-- COMMENTS -->
                        <div class="comment-section mt-2" id="comments-{{ plate.id }}" style="display:none;">
                            <ul class="list-group mb-2">
                                {% for comment in plate.comments %}
                                    <li class="list-group-item py-1 px-2">
                                        <strong>{{ comment.user.username }}:</strong> {{ comment.text }}
                                    </li>
                                {% endfor %}
                            </ul>

                            <form class="comment-form" data-plate="{{ plate.id }}">
                                <div class="input-group input-group-sm">
                                    <input type="text" name="text" class="form-control" placeholder="Write a comment..." required>
                                    <button class="btn btn-primary" type="submit">Post</button>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const plateFeed = document.getElementById('plate-feed');
    const userId = plateFeed.dataset.user;

    // --- LIKE BUTTON ---
    plateFeed.addEventListener('click', function (e) {
        const btn = e.target.closest('.like-btn');
        if (!btn) return;

        const plateId = btn.dataset.plate;

        fetch(`/plate/${plateId}/like`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `user_id=${userId}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.like_count !== undefined) {
                btn.querySelector('.like-count').textContent = data.like_count;
            }
        });
    });

    // --- COMMENT TOGGLE ---
    plateFeed.addEventListener('click', function (e) {
        const toggle = e.target.closest('.comment-toggle');
        if (!toggle) return;

        const plateId = toggle.dataset.plate;
        const section = document.getElementById(`comments-${plateId}`);

        section.style.display = section.style.display === 'none' ? 'block' : 'none';
    });

    // --- COMMENT SUBMIT ---
    plateFeed.addEventListener('submit', function (e) {
        if (!e.target.classList.contains('comment-form')) return;

        e.preventDefault();
        const form = e.target;
        const plateId = form.dataset.plate;
        const text = form.querySelector('input[name="text"]').value;

        fetch(`/plate/${plateId}/comment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `user_id=${userId}&text=${encodeURIComponent(text)}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'ok') {
                const ul = form.previousElementSibling;
                const li = document.createElement('li');
                li.className = 'list-group-item py-1 px-2';
                li.innerHTML = `<strong>${data.username}:</strong> ${text}`;
                ul.appendChild(li);
                form.reset();
            }
        });
    });
});
</script>
{% endblock %}
