{% extends "base.html" %}

{% block title %}Plate Feed{% endblock %}

{% block head %}
<style>
/* Keep your previous card/comment styling here */
.page-title { font-weight:800; font-size:2.3rem; text-align:center; margin-bottom:32px; background: linear-gradient(90deg,#ff6363,#ff995e); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.plate-card { border-radius:20px; overflow:hidden; background:#fff; border:1px solid #eaeaea; box-shadow:0 8px 30px rgba(0,0,0,0.07); transition: transform 0.2s ease, box-shadow 0.25s ease; }
.plate-card:hover { transform:translateY(-6px); box-shadow:0 14px 40px rgba(0,0,0,0.14); }
.plate-img { width:100%; height:250px; object-fit:cover; transition:transform 0.3s ease; }
.plate-card:hover .plate-img { transform:scale(1.06); }
.plate-body { padding:20px; }
.plate-title { font-size:1.25rem; font-weight:800; margin-bottom:6px; }
.plate-restaurant { font-size:0.96rem; color:#777; }
.star-display { color:#ffb400; font-size:1.1rem; }
.star-display .inactive { color:#ccc; }
.description-text { color:#555; font-size:0.97rem; margin-top:8px; }
.plate-actions { margin-top:10px; display:flex; gap:12px; }
.plate-actions button { border-radius:12px; font-weight:600; }
.comment-section { margin-top:15px; border-top:1px solid #eee; padding-top:10px; }
.comment { display:flex; gap:10px; margin-bottom:6px; }
.comment-avatar { width:30px; height:30px; border-radius:50%; background:#ff995e; color:#fff; font-weight:700; display:flex; justify-content:center; align-items:center; font-size:0.85rem; }
.comment-text { background:#f1f3f6; padding:6px 10px; border-radius:12px; font-size:0.9rem; }
.comment-toggle { color:#007bff; cursor:pointer; font-size:0.85rem; }
.new-comment input { width:100%; }
</style>
{% endblock %}

{% block content %}
<h1 class="page-title">Plate Feed</h1>

<!-- Search box -->
<form method="get" action="{{ url_for('search_plates') }}" class="mb-5">
    <div class="search-box p-3 mb-4 border rounded shadow-sm bg-white">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label>City / State / ZIP</label>
                <input type="text" class="form-control" name="location" value="{{ request.args.get('location','') }}">
            </div>
            <div class="col-md-2">
                <label>Radius (miles)</label>
                <input type="number" class="form-control" name="radius" value="{{ request.args.get('radius',10) }}" min="1">
            </div>
            <div class="col-md-3">
                <label>Category</label>
                <select class="form-select" name="category_id">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if request.args.get('category_id') == cat.id|string %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-grid">
                <button class="btn btn-primary">Search Plates</button>
                <a href="{{ url_for('search_plates') }}" class="btn btn-secondary mt-2">Show All Plates</a>
            </div>
        </div>
    </div>
</form>

<div class="row justify-content-center">
    {% for plate in plates %}
    <div class="col-12 col-md-6 col-lg-4 mb-4">
        <div class="plate-card">
            {% if plate.category %}<div class="category-banner">{{ plate.category.name }}</div>{% endif %}
            <img src="{{ plate.image_url or url_for('static', filename='uploads/placeholder.png') }}" class="plate-img">

            <div class="plate-body">
                <h5 class="plate-title">{{ plate.name }}</h5>
                <small class="text-muted">
                    Posted {{ plate.created_at.strftime('%b %d, %Y %I:%M %p') }} by
                    {% if plate.user %}
                        {{ plate.user.username }}
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="followUser({{ plate.user.id }}, this)">
                            {% if plate.user_followed %}Following{% else %}Follow{% endif %}
                        </button>
                    {% else %}Anonymous{% endif %}
                </small>

                <!-- Star Rating -->
                <div class="star-display mb-2">
                    {% if plate.avg_rating is not none and plate.avg_rating > 0 %}
                        {% set avg = plate.avg_rating %}
                        {% for i in range(1,6) %}
                            {% if i <= avg|round(0,'floor') %}&#9733;{% else %}<span class="inactive">&#9733;</span>{% endif %}
                        {% endfor %}
                        <span class="text-muted small">({{ avg }}/5)</span>
                    {% else %}
                        <span class="text-muted">Unrated</span>
                    {% endif %}
                </div>

                <p class="description-text">{{ plate.description or "No description." }}</p>

                <div class="plate-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="toggleLike({{ plate.id }}, this)">
                        Like ({{ plate.like_count or 0 }})
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="toggleFavorite({{ plate.id }}, this)">
                        {% if plate.user_favorited %}Favorited{% else %}Favorite{% endif %}
                    </button>
                </div>

                <!-- Comments -->
                <div class="comment-section">
                    {% if plate.comments %}
                        {% for c in plate.comments %}
                        <div class="comment">
                            <div class="comment-avatar">{{ c.user.username[0]|upper if c.user else '?' }}</div>
                            <div class="comment-text">{{ c.text }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted small">No comments yet.</p>
                    {% endif %}

                    {% if session.get('user_id') %}
                    <div class="new-comment mt-2">
                        <input type="text" class="form-control form-control-sm" placeholder="Add a comment..." data-plate="{{ plate.id }}">
                        <button class="btn btn-sm btn-primary mt-1" onclick="submitComment(this)">Post</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12 text-center text-muted">No plates found.</div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
function getCSRF() {
    return document.querySelector('meta[name="csrf-token"]').content;
}

function submitComment(btn) {
    const input = btn.previousElementSibling;
    const text = input.value.trim();
    const plateId = input.dataset.plate;
    if (!text) return;

    fetch(`/plates/${plateId}/comment`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRF()
        },
        body: JSON.stringify({ text })
    }).then(r => r.json()).then(data => {
        if (data.error) { showToast(data.error, 'danger'); return; }
        const html = `<div class="comment"><div class="comment-avatar">${data.username[0].toUpperCase()}</div><div class="comment-text">${data.text}</div></div>`;
        btn.closest('.comment-section').insertAdjacentHTML('beforeend', html);
        input.value = '';
        showToast('Comment posted!');
    });
}

function toggleLike(plateId, btn) {
    fetch(`/plates/${plateId}/like`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() }
    }).then(r => r.json()).then(data => {
        btn.textContent = `Like (${data.like_count})`;
        showToast(data.liked ? 'Liked!' : 'Unliked!');
    });
}

function toggleFavorite(plateId, btn) {
    fetch(`/plates/${plateId}/favorite`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() }
    }).then(r => r.json()).then(data => {
        btn.textContent = data.favorited ? 'Favorited' : 'Favorite';
        showToast(data.favorited ? 'Added to favorites!' : 'Removed from favorites!');
    });
}

function followUser(userId, btn) {
    fetch(`/users/${userId}/follow`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() }
    }).then(r => r.json()).then(data => {
        btn.textContent = data.following ? 'Following' : 'Follow';
        showToast(data.following ? 'You are now following!' : 'Unfollowed.');
    });
}
</script>
{% endblock %}
