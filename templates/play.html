
{% extends "base.html" %}

{% block title %}Play: Rate the Plate{% endblock %}

{% block content %}
<div class="container my-4 text-center">
    <h1 class="mb-4">Play: Rate the Plate</h1>

    <div id="game-container" style="position: relative;">
        <!-- Plate cards will appear here -->
    </div>

    <div class="mt-3">
        <button class="btn btn-success me-2" onclick="swipe('up')">üíõ Super Like</button>
        <button class="btn btn-primary me-2" onclick="swipe('right')">‚ù§Ô∏è Like</button>
        <button class="btn btn-danger" onclick="swipe('left')">‚ùå Dislike</button>
    </div>

    <p id="status" class="mt-2"></p>
</div>
{% endblock %}

{% block scripts %}
<script>
let plates = {{ plates|tojson }};
let currentIndex = 0;
const container = document.getElementById('game-container');
const status = document.getElementById('status');

function showPlate(index) {
    container.innerHTML = '';
    if(index >= plates.length){
        container.innerHTML = '<p>No more plates! üéâ</p>';
        return;
    }

    const plate = plates[index];
    const card = document.createElement('div');
    card.className = 'card shadow-sm mx-auto mb-4';
    card.style.width = '100%';
    card.style.maxWidth = '400px';      // limit width like a post
    card.style.borderRadius = '16px';
    card.style.overflow = 'hidden';
    card.style.touchAction = 'none';
    card.style.userSelect = 'none';

    // Image
    const img = document.createElement('img');
    img.src = plate.image_url;
    img.style.width = '100%';
    img.style.height = 'auto';
    img.style.display = 'block';

    // Card body
    const body = document.createElement('div');
    body.className = 'card-body bg-light';
    body.innerHTML = `
        <h5 class="card-title">${plate.name} (${plate.rating}/5)</h5>
        <p class="card-text">${plate.description || ''}</p>
        <small class="text-muted">${plate.restaurant ? plate.restaurant.name : 'Unknown restaurant'}</small>
    `;

    card.appendChild(img);
    card.appendChild(body);

    // swipe detection
    let startX, startY;
    card.addEventListener('touchstart', e => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    });

    card.addEventListener('touchend', e => {
        const dx = e.changedTouches[0].clientX - startX;
        const dy = e.changedTouches[0].clientY - startY;

        if(Math.abs(dx) > Math.abs(dy)){
            if(dx > 50) swipe('right');
            else if(dx < -50) swipe('left');
        } else {
            if(dy < -50) swipe('up');
        }
    });

    container.appendChild(card);
}

function swipe(direction){
    if(currentIndex >= plates.length) return;
    const plate = plates[currentIndex];

    fetch(`/plate/${plate.id}/swipe`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({direction: direction})
    });

    status.textContent = `You ${direction}ed: ${plate.name}`;
    currentIndex++;
    showPlate(currentIndex);
}

// initialize
showPlate(currentIndex);
</script>
{% endblock %}
