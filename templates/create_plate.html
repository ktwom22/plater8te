{% extends "base.html" %}

{% block title %}Post a Plate{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="text-center mb-4">Post a Plate</h1>

    <form method="POST" enctype="multipart/form-data" id="plate-form">

        <!-- Plate Name -->
        <div class="mb-3">
            <label for="name" class="form-label">Plate Name</label>
            <input type="text" class="form-control" id="name" name="name" required>
        </div>

        <!-- Description -->
        <div class="mb-3">
            <label for="description" class="form-label">Description (Optional)</label>
            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
        </div>

        <!-- âœ” FIXED: Category Dropdown -->
        <div class="mb-3">
            <label for="category_id" class="form-label">Category</label>
            <select class="form-select" id="category_id" name="category_id" required>
                <option value="">Select Category</option>
                {% for c in categories %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Image Upload -->
        <div class="mb-3">
            <label for="image" class="form-label">Upload Image</label>
            <input class="form-control" type="file" id="image" name="image" accept="image/*">
        </div>

        <!-- Restaurant Selection -->
        <div class="mb-3">
            <label class="form-label">Select Restaurant</label>

            <div class="d-flex flex-column flex-sm-row gap-2 mb-2">
                <button type="button" class="btn btn-outline-primary flex-grow-1" onclick="useNearby()">Nearby Restaurants</button>
                <button type="button" class="btn btn-outline-secondary flex-grow-1" onclick="useLocationInput()">Search by Zip or City</button>
            </div>

            <!-- Search box -->
            <div id="location-section" class="mb-2" style="display:none;">
                <input type="text" id="location-input" class="form-control mb-2" placeholder="Enter zip code or city">
                <button type="button" class="btn btn-primary w-100 mb-2" onclick="fetchRestaurants()">Search</button>
            </div>

            <!-- Restaurant list -->
            <select class="form-select mb-2" id="restaurant-list" required>
                <option value="">Select a restaurant</option>
            </select>

            <p id="selected-restaurant" class="text-muted"></p>

            <!-- Hidden fields sent to backend -->
            <input type="hidden" name="restaurant_name" id="restaurant_name">
            <input type="hidden" name="restaurant_address" id="restaurant_address">
            <input type="hidden" name="restaurant_latitude" id="restaurant_latitude">
            <input type="hidden" name="restaurant_longitude" id="restaurant_longitude">
        </div>

        <button type="submit" class="btn btn-success w-100">Post Plate</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
let lat, lon;
let useNearbyFlag = false;

function useNearby() {
    useNearbyFlag = true;
    document.getElementById('location-section').style.display = 'none';
    document.getElementById('restaurant-list').innerHTML = '<option>Loading nearby restaurants...</option>';

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            lat = pos.coords.latitude;
            lon = pos.coords.longitude;
            fetchRestaurants();
        }, () => alert('Unable to get your location.'));
    }
}

function useLocationInput() {
    useNearbyFlag = false;
    document.getElementById('location-section').style.display = 'block';
    document.getElementById('restaurant-list').innerHTML = '<option value="">Select a restaurant</option>';
}

function fetchRestaurants() {
    let url = '/nearby_restaurants';

    if (!useNearbyFlag) {
        const loc = document.getElementById('location-input').value.trim();
        if (!loc) return alert('Please enter a location.');
        url += `?location=${encodeURIComponent(loc)}`;
    } else {
        url += `?lat=${lat}&lon=${lon}`;
    }

    fetch(url)
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('restaurant-list');
            select.innerHTML = '<option value="">Select a restaurant</option>';

            if (data.error) return alert(data.error);

            data.restaurants.forEach(r => {
                const opt = document.createElement('option');
                opt.value = JSON.stringify(r);
                opt.textContent = `${r.name} (${r.address})`;
                select.appendChild(opt);
            });
        });
}

document.getElementById('restaurant-list').addEventListener('change', function() {
    const r = JSON.parse(this.value);
    document.getElementById('restaurant_name').value = r.name;
    document.getElementById('restaurant_address').value = r.address;
    document.getElementById('restaurant_latitude').value = r.latitude;
    document.getElementById('restaurant_longitude').value = r.longitude;
    document.getElementById('selected-restaurant').textContent = `Selected: ${r.name}`;
});
</script>
{% endblock %}
