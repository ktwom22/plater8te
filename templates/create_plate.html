{% extends "base.html" %}

{% block title %}Post a Plate{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="text-center mb-4">Post a Plate</h1>

    <form method="POST" enctype="multipart/form-data" id="plate-form">

        <!-- Nearby Restaurants -->
        <div class="mb-3">
            <label class="form-label">Select Restaurant</label>

            <div class="d-flex flex-column flex-sm-row gap-2 mb-2">
                <button type="button" class="btn btn-outline-primary flex-grow-1" onclick="useNearby()">Nearby Restaurants</button>
                <button type="button" class="btn btn-outline-secondary flex-grow-1" onclick="useLocationInput()">Search by Zip or City</button>
            </div>

            <div id="location-section" class="mb-2" style="display:none;">
                <input type="text" id="location-input" class="form-control mb-2" placeholder="Enter zip code or city">
                <button type="button" class="btn btn-primary w-100 mb-2" onclick="fetchRestaurants()">Search</button>
            </div>

            <!-- Hidden inputs for restaurant data -->
            <input type="hidden" name="restaurant_name" id="restaurant_name">
            <input type="hidden" name="restaurant_address" id="restaurant_address">
            <input type="hidden" name="restaurant_latitude" id="restaurant_latitude">
            <input type="hidden" name="restaurant_longitude" id="restaurant_longitude">

            <p id="selected-restaurant" class="text-muted"></p>
        </div>

        <!-- Plate Name -->
        <div class="mb-3">
            <label for="name" class="form-label">Plate Name</label>
            <input type="text" class="form-control" id="name" name="name" required>
        </div>

        <!-- Description -->
        <div class="mb-3">
            <label for="description" class="form-label">Description (Optional)</label>
            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
        </div>

        <!-- Category Autocomplete -->
        <div class="mb-3 position-relative">
            <label for="category_id" class="form-label">Category</label>
            <input type="text" id="category_search" class="form-control" placeholder="Start typing to search..." autocomplete="off" required>
            <select id="category_id" name="category_id" class="form-select d-none">
                <option value="">Select Category</option>
                {% for c in categories %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
            </select>
            <ul id="category_suggestions" class="list-group position-absolute w-100" style="z-index:1100; display:none;"></ul>
        </div>

        <!-- Image Upload -->
        <div class="mb-3">
            <label for="image" class="form-label">Upload Image</label>
            <input class="form-control" type="file" id="image" name="image" accept="image/*">
            <img id="image-preview" src="#" alt="Image Preview" class="mt-2" style="display:none; max-width:100%; height:auto; border-radius:8px;">
        </div>

        <button type="submit" class="btn btn-success w-100">Post Plate</button>
    </form>
</div>

<!-- Restaurant Modal -->
<div class="modal fade" id="restaurantModal" tabindex="-1" aria-labelledby="restaurantModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="restaurantModalLabel">Select a Restaurant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="restaurant-loading" class="text-center my-3 d-none">
          <div class="spinner-border text-primary" role="status"></div>
          <p>Loading nearby restaurants...</p>
        </div>
        <ul id="restaurant-list" class="list-group"></ul>

        <!-- Add Restaurant Form (hidden initially) -->
        <div id="add-restaurant-section" class="mt-3" style="display:none;">
            <h6>Add a New Restaurant</h6>
            <div class="mb-2">
                <input type="text" id="new_restaurant_name" class="form-control" placeholder="Restaurant Name">
            </div>
            <div class="mb-2">
                <input type="text" id="new_restaurant_address" class="form-control" placeholder="Address">
            </div>
            <div class="mb-2">
                <input type="text" id="new_restaurant_city" class="form-control" placeholder="City">
            </div>
            <div class="mb-2">
                <input type="text" id="new_restaurant_state" class="form-control" placeholder="State">
            </div>
            <div class="mb-2">
                <input type="text" id="new_restaurant_website" class="form-control" placeholder="Website (Optional)">
            </div>
            <button type="button" class="btn btn-success w-100" onclick="addRestaurant()">Add Restaurant</button>
        </div>

        <button type="button" class="btn btn-link mt-2" id="show-add-restaurant">Can't find your restaurant? Add it</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let lat, lon;
    let useNearbyFlag = false;
    let cachedRestaurants = [];

    // Image Preview
    const imageInput = document.getElementById('image');
    imageInput.addEventListener('change', function() {
        const [file] = this.files;
        if(file){
            const preview = document.getElementById('image-preview');
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
        }
    });

    // Nearby Restaurants
    window.useNearby = function() {
        useNearbyFlag = true;
        document.getElementById('location-section').style.display = 'none';
        showModal();
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                lat = pos.coords.latitude;
                lon = pos.coords.longitude;
                fetchRestaurants();
                prefillAddress(lat, lon);
            }, () => alert('Unable to get your location.'));
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    };

    window.useLocationInput = function() {
        useNearbyFlag = false;
        document.getElementById('location-section').style.display = 'block';
    };

    function showModal() {
        const modal = new bootstrap.Modal(document.getElementById('restaurantModal'));
        modal.show();
        document.getElementById('restaurant-loading').classList.remove('d-none');
        document.getElementById('restaurant-list').classList.add('d-none');
    }

    function hideModal() {
        const modalEl = document.getElementById('restaurantModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if(modal) modal.hide();
    }

    window.fetchRestaurants = function() {
        let url = '/nearby_restaurants';
        if (!useNearbyFlag) {
            const loc = document.getElementById('location-input').value.trim();
            if (!loc) return alert('Please enter a location.');
            url += `?location=${encodeURIComponent(loc)}`;
        } else {
            url += `?lat=${lat}&lon=${lon}`;
        }

        const loading = document.getElementById('restaurant-loading');
        const listEl = document.getElementById('restaurant-list');
        loading.classList.remove('d-none');
        listEl.classList.add('d-none');

        fetch(url)
        .then(res => res.json())
        .then(data => {
            loading.classList.add('d-none');
            listEl.classList.remove('d-none');
            listEl.innerHTML = '';

            if(data.error) {
                listEl.innerHTML = `<li class="list-group-item text-danger">${data.error}</li>`;
                return;
            }

            // Filter fast food
            cachedRestaurants = data.restaurants.filter(r => !/mcdonald|burger king|wendy's|taco bell|dunkin/i.test(r.name));

            if(cachedRestaurants.length === 0) {
                listEl.innerHTML = `<li class="list-group-item">No restaurants found.</li>`;
                return;
            }

            cachedRestaurants.forEach(r => {
                const li = document.createElement('li');
                li.className = 'list-group-item list-group-item-action';
                li.style.cursor = 'pointer';
                li.innerHTML = `<strong>${r.name}</strong><br>${r.address}`;
                li.addEventListener('click', () => selectRestaurant(r));
                listEl.appendChild(li);
            });
        }).catch(err => {
            loading.classList.add('d-none');
            listEl.classList.remove('d-none');
            listEl.innerHTML = `<li class="list-group-item text-danger">Error fetching restaurants</li>`;
            console.error(err);
        });
    };

    window.selectRestaurant = function(r) {
        document.getElementById('restaurant_name').value = r.name;
        document.getElementById('restaurant_address').value = r.address;
        document.getElementById('restaurant_latitude').value = r.latitude;
        document.getElementById('restaurant_longitude').value = r.longitude;
        document.getElementById('selected-restaurant').textContent = `Selected: ${r.name}`;
        hideModal();
    };

    // Show Add Restaurant Form
    document.getElementById('show-add-restaurant').addEventListener('click', () => {
        document.getElementById('add-restaurant-section').style.display = 'block';
        document.getElementById('show-add-restaurant').style.display = 'none';
    });

    function prefillAddress(lat, lon) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
        .then(res => res.json())
        .then(data => {
            const addr = data.address || {};
            document.getElementById('new_restaurant_address').value = addr.road || '';
            document.getElementById('new_restaurant_city').value = addr.city || addr.town || addr.village || '';
            document.getElementById('new_restaurant_state').value = addr.state || '';
        }).catch(err => console.error('Prefill address failed:', err));
    }

    window.addRestaurant = function() {
        const name = document.getElementById('new_restaurant_name').value.trim();
        const address = document.getElementById('new_restaurant_address').value.trim();
        const city = document.getElementById('new_restaurant_city').value.trim();
        const state = document.getElementById('new_restaurant_state').value.trim();
        const website = document.getElementById('new_restaurant_website').value.trim();

        if(!name || !address || !city || !state) return alert('Please fill in all required fields.');

        const fullAddress = `${address}, ${city}, ${state}`;

        document.getElementById('restaurant_name').value = name;
        document.getElementById('restaurant_address').value = fullAddress;
        document.getElementById('restaurant_latitude').value = lat || '';
        document.getElementById('restaurant_longitude').value = lon || '';
        hideModal();
        document.getElementById('selected-restaurant').textContent = `Selected: ${name}`;
    };

    // Category Autocomplete
    const categoryInput = document.getElementById('category_search');
    const categorySelect = document.getElementById('category_id');
    const categorySuggestions = document.getElementById('category_suggestions');

    const categoryMap = {};
    Array.from(categorySelect.options).forEach(opt => {
        if(opt.value) categoryMap[opt.text] = opt.value;
    });

    categoryInput.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        categorySuggestions.innerHTML = '';

        const matches = Object.keys(categoryMap).filter(name => name.toLowerCase().includes(value));
        if(!matches.length) return categorySuggestions.style.display = 'none';

        matches.forEach(name => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action';
            li.style.cursor = 'pointer';
            const regex = new RegExp(`(${value})`, 'i');
            li.innerHTML = name.replace(regex, '<mark>$1</mark>');
            li.addEventListener('click', () => {
                categoryInput.value = name;
                categorySelect.value = categoryMap[name];
                categorySuggestions.style.display = 'none';
            });
            categorySuggestions.appendChild(li);
        });

        categorySuggestions.style.display = 'block';
        categorySuggestions.firstChild.scrollIntoView({block:"nearest"});
    });

    document.addEventListener('click', e => {
        if(!categoryInput.contains(e.target) && !categorySuggestions.contains(e.target)) {
            categorySuggestions.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
